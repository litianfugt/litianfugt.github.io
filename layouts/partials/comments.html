{{- /* Giscus Comments System */ -}}

{{- if .Site.Params.comments.enable }}
<div class="giscus-container">
    <!-- Giscus评论将通过JavaScript动态加载 -->
    <div class="giscus-loading">加载评论中...</div>
</div>

<style>
    .giscus-container {
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 1px solid var(--border);
    }
    
    .giscus-loading {
        text-align: center;
        padding: 20px;
        color: var(--secondary);
        font-size: 14px;
    }
    
    .giscus-frame {
        border-radius: 8px;
        box-shadow: 0 2px 8px var(--shadow-light);
    }
    
    /* Dark mode support for Giscus */
    @media (prefers-color-scheme: dark) {
        .giscus-frame {
            filter: brightness(0.9);
        }
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .giscus-container {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
        }
    }
</style>

{{- /* 动态加载Giscus评论系统 */ -}}
<script>
    // 动态加载Giscus评论系统
    function loadGiscus() {
        console.log('Giscus: loadGiscus function called');
        
        // 查找所有可见的评论容器
        const commentContainers = document.querySelectorAll('.thought-comments[style*="display: block"], .thought-comments:not([style])');
        
        console.log('Giscus: Found', commentContainers.length, 'visible comment containers');
        
        commentContainers.forEach(container => {
            console.log('Giscus: Processing container:', container.id);
            
            const giscusContainer = container.querySelector('.giscus-container');
            if (!giscusContainer) {
                console.warn('Giscus: No giscus-container found in', container.id);
                return;
            }
            
            if (giscusContainer.querySelector('.giscus-frame')) {
                console.log('Giscus: Frame already exists in', container.id);
                return;
            }
            
            // 清除加载提示
            const loading = giscusContainer.querySelector('.giscus-loading');
            if (loading) loading.remove();
            
            // 创建Giscus脚本
            const script = document.createElement('script');
            script.src = 'https://giscus.app/client.js';
            script.setAttribute('data-repo', '{{ .Site.Params.comments.giscus.repo }}');
            script.setAttribute('data-repo-id', '{{ .Site.Params.comments.giscus.repoId }}');
            script.setAttribute('data-category', '{{ .Site.Params.comments.giscus.category }}');
            script.setAttribute('data-category-id', '{{ .Site.Params.comments.giscus.categoryId }}');
            script.setAttribute('data-mapping', '{{ .Site.Params.comments.giscus.mapping | default "pathname" }}');
            script.setAttribute('data-strict', '{{ .Site.Params.comments.giscus.strict | default "0" }}');
            script.setAttribute('data-reactions-enabled', '{{ .Site.Params.comments.giscus.reactionsEnabled | default "1" }}');
            script.setAttribute('data-emit-metadata', '{{ .Site.Params.comments.giscus.emitMetadata | default "0" }}');
            script.setAttribute('data-input-position', '{{ .Site.Params.comments.giscus.inputPosition | default "bottom" }}');
            script.setAttribute('data-theme', '{{ .Site.Params.comments.giscus.theme | default "preferred_color_scheme" }}');
            script.setAttribute('data-lang', '{{ .Site.Params.comments.giscus.lang | default "zh-CN" }}');
            script.setAttribute('data-loading', '{{ .Site.Params.comments.giscus.loading | default "eager" }}');
            script.setAttribute('crossorigin', 'anonymous');
            script.setAttribute('async', '');
            
            console.log('Giscus: Adding script to container', container.id);
            
            // 监听Giscus事件来更新评论计数
            script.addEventListener('load', function() {
                console.log('Giscus: Script loaded for', container.id);
                
                // 监听Giscus的评论变化事件
                window.addEventListener('message', function(event) {
                    if (event.origin !== 'https://giscus.app') return;
                    
                    if (event.data && event.data.giscus) {
                        const giscusData = event.data.giscus;
                        console.log('Giscus: Received message', giscusData);
                        
                        if (giscusData.discussion && giscusData.discussion.totalCommentCount !== undefined) {
                            const commentCount = giscusData.discussion.totalCommentCount;
                            console.log('Giscus: Comment count updated to', commentCount);
                            
                            // 更新评论计数
                            updateCommentCount(container.id, commentCount);
                        }
                    }
                });
                
                // 定期检查评论数量（备用方案）
                const checkCommentCount = setInterval(() => {
                    try {
                        const iframe = giscusContainer.querySelector('iframe.giscus-frame');
                        if (iframe && iframe.contentWindow) {
                            iframe.contentWindow.postMessage({
                                giscus: {
                                    discussion: {
                                        id: container.id.replace('comments-', ''),
                                        totalCommentCount: null
                                    }
                                }
                            }, 'https://giscus.app');
                        }
                    } catch (e) {
                        console.log('Giscus: Error checking comment count', e);
                    }
                }, 5000);
                
                // 10秒后停止检查
                setTimeout(() => clearInterval(checkCommentCount), 10000);
            });
            
            giscusContainer.appendChild(script);
        });
    }
    
    // 更新评论计数的函数
    function updateCommentCount(containerId, count) {
        // 从容器ID中提取thought ID
        const thoughtId = containerId.replace('comments-', '');
        console.log('Giscus: Updating comment count for', thoughtId, 'to', count);
        
        // 查找对应的评论按钮
        const commentButtons = document.querySelectorAll('.thought-action.comment-btn[data-thought-id="' + thoughtId + '"]');
        commentButtons.forEach(button => {
            const countSpan = button.querySelector('.comment-count');
            if (countSpan) {
                countSpan.textContent = count;
                console.log('Giscus: Updated comment count for', thoughtId, 'to', count);
            }
        });
    }
    
    // 如果评论区域可见，立即加载评论
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Giscus: DOM content loaded, setting up observer');
        
        // 不在页面加载时立即加载评论，而是监听评论区域显示/隐藏变化
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                    const target = mutation.target;
                    if (target.classList.contains('thought-comments') &&
                        (target.style.display === 'block' || !target.style.display)) {
                        console.log('Giscus: Comment section became visible, loading Giscus');
                        loadGiscus();
                    }
                }
            });
        });
        
        // 观察所有评论区域
        document.querySelectorAll('.thought-comments').forEach(function(el) {
            console.log('Giscus: Setting up observer for', el.id);
            observer.observe(el, { attributes: true });
        });
    });
    
    // 将loadGiscus和updateCommentCount函数暴露到全局作用域，以便其他脚本可以调用
    window.loadGiscus = loadGiscus;
    window.updateCommentCount = updateCommentCount;
</script>
{{- end }}