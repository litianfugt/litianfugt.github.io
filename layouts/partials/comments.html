{{- /* Giscus Comments System */ -}}

{{- if .Site.Params.comments.enable }}
<div class="giscus-container">
    <!-- Giscus评论将通过JavaScript动态加载 -->
    <div class="giscus-loading">加载评论中...</div>
</div>

<style>
    .giscus-container {
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 1px solid var(--border);
    }
    
    .giscus-loading {
        text-align: center;
        padding: 20px;
        color: var(--secondary);
        font-size: 14px;
    }
    
    .giscus-frame {
        border-radius: 8px;
        box-shadow: 0 2px 8px var(--shadow-light);
    }
    
    /* Dark mode support for Giscus */
    @media (prefers-color-scheme: dark) {
        .giscus-frame {
            filter: brightness(0.9);
        }
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .giscus-container {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
        }
    }
</style>

{{- /* 动态加载Giscus评论系统 */ -}}
<script>
    console.log('Comments.html: Starting to load CommentManager...');
    
    // 添加全局错误处理
    window.addEventListener('error', function(e) {
        if (e.message.includes('commentManager') || e.message.includes('CommentManager')) {
            console.error('Global error handler caught CommentManager error:', e);
        }
    });

    // 添加未处理的 Promise 拒绝处理
    window.addEventListener('unhandledrejection', function(e) {
        if (e.reason && e.reason.message && e.reason.message.includes('commentManager')) {
            console.error('Unhandled promise rejection related to CommentManager:', e.reason);
        }
    });

    // CommentManager 类实现
    class CommentManager {
        constructor() {
            this.instances = new Map();
            this.activeInstance = null;
            this.initialized = true;
            console.log('CommentManager: Initialized successfully');
        }
        
        // 获取或创建评论实例
        getInstance(thoughtId) {
            if (!this.instances.has(thoughtId)) {
                console.log('CommentManager: Creating new instance for thought:', thoughtId);
                this.instances.set(thoughtId, {
                    thoughtId: thoughtId,
                    containerId: `comments-${thoughtId}`,
                    container: null,
                    isActive: false,
                    isLoading: false,
                    
                    // 创建评论容器
                    createContainer: function() {
                        const placeholder = document.getElementById(`comments-placeholder-${this.thoughtId}`);
                        if (!placeholder) {
                            console.error('CommentInstance: Placeholder not found for thought:', this.thoughtId);
                            return;
                        }
                        
                        this.container = document.createElement('div');
                        this.container.id = this.containerId;
                        this.container.className = 'thought-comments';
                        this.container.style.display = 'block';
                        
                        this.container.innerHTML = `
                            <div class="giscus-container">
                                <div class="giscus-loading">加载评论中...</div>
                            </div>
                        `;
                        
                        placeholder.parentNode.replaceChild(this.container, placeholder);
                        console.log('CommentInstance: Created container for thought:', this.thoughtId);
                    },
                    
                    // 加载Giscus
                    loadGiscus: function() {
                        console.log('CommentInstance: loadGiscus called for thought:', this.thoughtId);
                        const giscusContainer = this.container.querySelector('.giscus-container');
                        if (!giscusContainer) {
                            console.error('CommentInstance: Giscus container not found for thought:', this.thoughtId);
                            return;
                        }
                        
                        // 清理现有的Giscus实例 - 增强版
                        console.log('CommentInstance: Starting comprehensive Giscus cleanup for thought:', this.thoughtId);
                        
                        // 1. 清理当前容器中的Giscus元素
                        const existingFrame = giscusContainer.querySelector('iframe.giscus-frame');
                        if (existingFrame) {
                            console.log('CommentInstance: Removing existing frame for thought:', this.thoughtId);
                            existingFrame.remove();
                        } else {
                            console.log('CommentInstance: No existing frame found for thought:', this.thoughtId);
                        }
                        
                        const existingScript = giscusContainer.querySelector('script[src="https://giscus.app/client.js"]');
                        if (existingScript) {
                            console.log('CommentInstance: Removing existing script for thought:', this.thoughtId);
                            existingScript.remove();
                        } else {
                            console.log('CommentInstance: No existing script found for thought:', this.thoughtId);
                        }
                        
                        // 2. 清理全局范围内的Giscus元素（防止多个实例冲突）
                        const allGiscusFrames = document.querySelectorAll('iframe.giscus-frame');
                        const allGiscusScripts = document.querySelectorAll('script[src="https://giscus.app/client.js"]');
                        console.log('CommentInstance: Global Giscus check before cleanup - Frames:', allGiscusFrames.length, 'Scripts:', allGiscusScripts.length);
                        
                        // 移除所有其他Giscus框架（除了当前容器中的，因为上面已经处理了）
                        allGiscusFrames.forEach(frame => {
                            if (frame.closest('.giscus-container') !== giscusContainer) {
                                console.log('CommentInstance: Removing external frame from container:', frame.closest('.thought-comments')?.id);
                                frame.remove();
                            }
                        });
                        
                        // 移除所有其他Giscus脚本（除了当前容器中的，因为上面已经处理了）
                        allGiscusScripts.forEach(script => {
                            if (script.closest('.giscus-container') !== giscusContainer) {
                                console.log('CommentInstance: Removing external script from container:', script.closest('.thought-comments')?.id);
                                script.remove();
                            }
                        });
                        
                        // 3. 清理Giscus相关的DOM元素和样式
                        const giscusElements = giscusContainer.querySelectorAll('.giscus, .giscus-frame, [class*="giscus"]');
                        giscusElements.forEach(element => {
                            if (element.tagName !== 'SCRIPT' && element.tagName !== 'IFRAME') {
                                console.log('CommentInstance: Removing additional Giscus element:', element.className);
                                element.remove();
                            }
                        });
                        
                        // 4. 重置容器状态
                        giscusContainer.innerHTML = '<div class="giscus-loading">加载评论中...</div>';
                        
                        console.log('CommentInstance: Giscus cleanup completed for thought:', this.thoughtId);
                        
                        // 重置加载提示
                        const loading = giscusContainer.querySelector('.giscus-loading');
                        if (loading) {
                            loading.style.display = 'block';
                            loading.textContent = '加载评论中...';
                            loading.style.color = '';
                        }
                        
                        // 获取随想信息
                        const thoughtCard = document.querySelector(`.thought-card[data-thought-id="${this.thoughtId}"]`);
                        let thoughtContent = '';
                        let thoughtTitle = `随想 ${this.thoughtId}`;
                        
                        if (thoughtCard) {
                            const contentElement = thoughtCard.querySelector('.thought-content');
                            if (contentElement) {
                                const contentText = contentElement.textContent.trim();
                                thoughtContent = contentText;
                                thoughtTitle = contentText.substring(0, 50) + (contentText.length > 50 ? '...' : '');
                            }
                        }
                        
                        // 创建Giscus脚本
                        const script = document.createElement('script');
                        script.src = 'https://giscus.app/client.js';
                        
                        const pagePath = window.location.pathname;
                        const uniqueId = `${pagePath}#${this.thoughtId}`;
                        
                        script.setAttribute('data-repo', '{{ .Site.Params.comments.giscus.repo }}');
                        script.setAttribute('data-repo-id', '{{ .Site.Params.comments.giscus.repoId }}');
                        script.setAttribute('data-category', '{{ .Site.Params.comments.giscus.category }}');
                        script.setAttribute('data-category-id', '{{ .Site.Params.comments.giscus.categoryId }}');
                        script.setAttribute('data-mapping', 'specific');
                        script.setAttribute('data-term', uniqueId);
                        script.setAttribute('data-title', thoughtTitle);
                        if (thoughtContent) {
                            script.setAttribute('data-description', thoughtContent);
                        }
                        script.setAttribute('data-strict', '{{ .Site.Params.comments.giscus.strict | default "0" }}');
                        script.setAttribute('data-reactions-enabled', '{{ .Site.Params.comments.giscus.reactionsEnabled | default "1" }}');
                        script.setAttribute('data-emit-metadata', '{{ .Site.Params.comments.giscus.emitMetadata | default "0" }}');
                        script.setAttribute('data-input-position', '{{ .Site.Params.comments.giscus.inputPosition | default "bottom" }}');
                        script.setAttribute('data-theme', '{{ .Site.Params.comments.giscus.theme | default "preferred_color_scheme" }}');
                        script.setAttribute('data-lang', '{{ .Site.Params.comments.giscus.lang | default "zh-CN" }}');
                        script.setAttribute('data-loading', '{{ .Site.Params.comments.giscus.loading | default "eager" }}');
                        script.setAttribute('crossorigin', 'anonymous');
                        script.setAttribute('async', '');
                        
                        // 设置加载事件
                        script.addEventListener('load', () => {
                            console.log('CommentInstance: Giscus loaded for thought:', this.thoughtId);
                            const loading = giscusContainer.querySelector('.giscus-loading');
                            if (loading) {
                                loading.style.display = 'none';
                            }
                            
                            // 更新评论计数
                            setTimeout(() => {
                                updateCommentCountFromGiscus(this.thoughtId);
                            }, 1000); // 延迟1秒确保Giscus完全加载
                        });
                        
                        script.addEventListener('error', () => {
                            console.error('CommentInstance: Giscus load error for thought:', this.thoughtId);
                            const loading = giscusContainer.querySelector('.giscus-loading');
                            if (loading) {
                                loading.textContent = '评论加载失败，请刷新页面重试';
                                loading.style.color = '#F44336';
                            }
                        });
                        
                        giscusContainer.appendChild(script);
                        console.log('CommentInstance: Loading Giscus for thought:', this.thoughtId);
                    },
                    
                    // 显示评论
                    show: function() {
                        if (this.container) {
                            this.container.style.display = 'block';
                            console.log('CommentInstance: Showing comments for thought:', this.thoughtId);
                        }
                    },
                    
                    // 隐藏评论
                    hide: function() {
                        if (this.container) {
                            this.container.style.display = 'none';
                            console.log('CommentInstance: Hiding comments for thought:', this.thoughtId);
                        }
                    },
                    
                    // 加载评论 - 修复异步处理
                    load: async function() {
                        if (this.isActive) return;
                        
                        console.log('CommentInstance: Starting load process for thought:', this.thoughtId);
                        this.isLoading = true;
                        
                        try {
                            // 创建容器
                            this.createContainer();
                            
                            // 等待一小段时间确保DOM更新完成
                            await new Promise(resolve => setTimeout(resolve, 50));
                            
                            // 直接加载Giscus，不使用异步包装
                            this.loadGiscus();
                            
                            // 标记为活动状态，不等待Giscus完全加载
                            this.isActive = true;
                            console.log('CommentInstance: Load process initiated for thought:', this.thoughtId);
                        } catch (error) {
                            console.error('CommentInstance: Error during load process for thought:', this.thoughtId, error);
                            // 即使出错也标记为活动状态，避免用户无法操作
                            this.isActive = true;
                        } finally {
                            this.isLoading = false;
                        }
                    },
                    
                    // 销毁评论实例
                    destroy: function() {
                        console.log('CommentInstance: Destroying instance for thought:', this.thoughtId);
                        
                        if (this.container && this.container.parentNode) {
                            const placeholder = document.createElement('div');
                            placeholder.id = `comments-placeholder-${this.thoughtId}`;
                            placeholder.className = 'thought-comments-placeholder';
                            placeholder.setAttribute('data-thought-id', this.thoughtId);
                            
                            this.container.parentNode.replaceChild(placeholder, this.container);
                            this.container = null;
                        }
                        
                        this.isActive = false;
                        this.isLoading = false;
                    }
                });
            }
            return this.instances.get(thoughtId);
        }
        
        // 激活评论实例
        async activateInstance(thoughtId) {
            console.log('CommentManager: Activating instance for thought:', thoughtId);
            console.log('CommentManager: Current active instance:', this.activeInstance ? this.activeInstance.thoughtId : 'none');
            console.log('CommentManager: Total instances count:', this.instances.size);
            console.log('CommentManager: All instance IDs:', Array.from(this.instances.keys()));
            
            // 添加加载状态指示
            this.setLoadingState(thoughtId, true);
            
            try {
                // 如果有活动的实例且不同，先停用它
                if (this.activeInstance && this.activeInstance.thoughtId !== thoughtId) {
                    console.log('CommentManager: Deactivating current instance for thought:', this.activeInstance.thoughtId);
                    console.log('CommentManager: Before deactivation - instance state:', {
                        isActive: this.activeInstance.isActive,
                        isLoading: this.activeInstance.isLoading,
                        hasContainer: !!this.activeInstance.container
                    });
                    
                    // 使用增强版的停用方法
                    await this.deactivateCurrentInstanceAsync();
                    
                    // 额外确保全局Giscus元素被清理
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    const allGiscusFrames = document.querySelectorAll('iframe.giscus-frame');
                    const allGiscusScripts = document.querySelectorAll('script[src="https://giscus.app/client.js"]');
                    console.log('CommentManager: Global Giscus check after deactivation - Frames:', allGiscusFrames.length, 'Scripts:', allGiscusScripts.length);
                    
                    if (allGiscusFrames.length > 0 || allGiscusScripts.length > 0) {
                        console.log('CommentManager: Cleaning up remaining global Giscus elements');
                        allGiscusFrames.forEach(frame => frame.remove());
                        allGiscusScripts.forEach(script => script.remove());
                    }
                }
                
                const instance = this.getInstance(thoughtId);
                console.log('CommentManager: Got instance for thought:', thoughtId, 'isActive:', instance.isActive);
                console.log('CommentManager: Instance container exists:', !!instance.container);
                this.activeInstance = instance;
                
                if (!instance.isActive) {
                    console.log('CommentManager: Loading new instance for thought:', thoughtId);
                    console.log('CommentManager: Before load - instance.isLoading:', instance.isLoading);
                    
                    // 确保实例容器已创建
                    if (!instance.container) {
                        instance.createContainer();
                    }
                    
                    // 加载Giscus
                    await instance.loadGiscus();
                    
                    // 标记实例为活动状态
                    instance.isActive = true;
                    instance.isLoading = false;
                    
                    console.log('CommentManager: After load - instance.isActive:', instance.isActive, 'instance.isLoading:', instance.isLoading);
                    console.log('CommentManager: Instance loaded for thought:', thoughtId);
                } else {
                    console.log('CommentManager: Instance already active for thought:', thoughtId);
                }
                
                instance.show();
                console.log('CommentManager: Instance activated for thought:', thoughtId);
                console.log('CommentManager: Final state - activeInstance.thoughtId:', this.activeInstance.thoughtId);
                
                // 更新按钮状态
                this.updateButtonState(thoughtId, true);
                
            } catch (error) {
                console.error('CommentManager: Error activating instance for thought:', thoughtId, error);
                
                // 重置按钮状态
                this.updateButtonState(thoughtId, false);
                
                // 显示错误通知
                this.showNotification('评论加载失败，请刷新页面重试', 'error');
            } finally {
                // 移除加载状态指示
                this.setLoadingState(thoughtId, false);
            }
        }
        
        // 异步停用当前实例
        async deactivateCurrentInstanceAsync() {
            if (this.activeInstance) {
                console.log('CommentManager: Asynchronously deactivating current instance for thought:', this.activeInstance.thoughtId);
                console.log('CommentManager: Before deactivation - instance state:', {
                    isActive: this.activeInstance.isActive,
                    isLoading: this.activeInstance.isLoading,
                    hasContainer: !!this.activeInstance.container
                });
                
                // 1. 隐藏评论容器
                this.activeInstance.hide();
                
                // 2. 更新按钮状态
                this.updateButtonState(this.activeInstance.thoughtId, false);
                
                // 3. 强制清理Giscus实例
                if (this.activeInstance.container) {
                    const giscusContainer = this.activeInstance.container.querySelector('.giscus-container');
                    if (giscusContainer) {
                        console.log('CommentManager: Force cleaning Giscus container for thought:', this.activeInstance.thoughtId);
                        
                        // 移除所有Giscus相关元素
                        const frames = giscusContainer.querySelectorAll('iframe.giscus-frame');
                        const scripts = giscusContainer.querySelectorAll('script[src="https://giscus.app/client.js"]');
                        
                        frames.forEach(frame => {
                            console.log('CommentManager: Removing frame during deactivation');
                            frame.remove();
                        });
                        
                        scripts.forEach(script => {
                            console.log('CommentManager: Removing script during deactivation');
                            script.remove();
                        });
                        
                        // 重置容器内容
                        giscusContainer.innerHTML = '<div class="giscus-loading">加载评论中...</div>';
                    }
                }
                
                // 4. 重置实例状态
                this.activeInstance.isActive = false;
                this.activeInstance.isLoading = false;
                
                // 5. 清除活动实例引用
                this.activeInstance = null;
                
                console.log('CommentManager: Asynchronous deactivation completed');
                
                // 返回一个Promise，确保异步操作完成
                return Promise.resolve();
            } else {
                console.log('CommentManager: No active instance to deactivate');
                return Promise.resolve();
            }
        }
        
        // 设置加载状态
        setLoadingState(thoughtId, isLoading) {
            const button = document.querySelector(`.thought-action.comment-btn[data-thought-id="${thoughtId}"]`);
            if (button) {
                if (isLoading) {
                    button.classList.add('loading');
                    // 可以在这里添加加载指示器
                } else {
                    button.classList.remove('loading');
                }
            }
        }
        
        // 更新按钮状态
        updateButtonState(thoughtId, isActive) {
            const button = document.querySelector(`.thought-action.comment-btn[data-thought-id="${thoughtId}"]`);
            if (button) {
                if (isActive) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            }
        }
        
        // 显示通知
        showNotification(message, type = 'info') {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            // 设置样式
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 14px 22px;
                border-radius: 8px;
                color: white;
                font-size: 14px;
                z-index: 1000;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                max-width: 320px;
                word-wrap: break-word;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                font-weight: 500;
            `;
            
            // 根据类型设置背景色
            const colors = {
                success: '#4CAF50',
                warning: '#FF9800',
                error: '#F44336',
                info: '#2196F3'
            };
            
            notification.style.backgroundColor = colors[type] || colors.info;
            
            // 添加到页面
            document.body.appendChild(notification);
            
            // 显示动画
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 10);
            
            // 自动隐藏
            const hideDelay = type === 'error' ? 5000 : 3000;
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, hideDelay);
        }
        
        // 停用当前实例 - 增强版
        deactivateCurrentInstance() {
            if (this.activeInstance) {
                console.log('CommentManager: Deactivating current instance for thought:', this.activeInstance.thoughtId);
                console.log('CommentManager: Before deactivation - instance state:', {
                    isActive: this.activeInstance.isActive,
                    isLoading: this.activeInstance.isLoading,
                    hasContainer: !!this.activeInstance.container
                });
                
                // 1. 隐藏评论容器
                this.activeInstance.hide();
                
                // 2. 强制清理Giscus实例
                if (this.activeInstance.container) {
                    const giscusContainer = this.activeInstance.container.querySelector('.giscus-container');
                    if (giscusContainer) {
                        console.log('CommentManager: Force cleaning Giscus container for thought:', this.activeInstance.thoughtId);
                        
                        // 移除所有Giscus相关元素
                        const frames = giscusContainer.querySelectorAll('iframe.giscus-frame');
                        const scripts = giscusContainer.querySelectorAll('script[src="https://giscus.app/client.js"]');
                        
                        frames.forEach(frame => {
                            console.log('CommentManager: Removing frame during deactivation');
                            frame.remove();
                        });
                        
                        scripts.forEach(script => {
                            console.log('CommentManager: Removing script during deactivation');
                            script.remove();
                        });
                        
                        // 重置容器内容
                        giscusContainer.innerHTML = '<div class="giscus-loading">加载评论中...</div>';
                    }
                }
                
                // 3. 重置实例状态
                this.activeInstance.isActive = false;
                this.activeInstance.isLoading = false;
                
                // 4. 清除活动实例引用
                this.activeInstance = null;
                
                console.log('CommentManager: Deactivation completed');
            } else {
                console.log('CommentManager: No active instance to deactivate');
            }
        }
        
        // 完全销毁指定实例
        destroyInstance(thoughtId) {
            console.log('CommentManager: Destroying instance for thought:', thoughtId);
            
            const instance = this.instances.get(thoughtId);
            if (instance) {
                // 如果是活动实例，先停用
                if (this.activeInstance && this.activeInstance.thoughtId === thoughtId) {
                    this.deactivateCurrentInstance();
                }
                
                // 销毁实例
                instance.destroy();
                
                // 从实例映射中移除
                this.instances.delete(thoughtId);
                
                console.log('CommentManager: Instance destroyed and removed from map');
            } else {
                console.log('CommentManager: Instance not found for destruction:', thoughtId);
            }
        }
    }

    // 从Giscus更新评论计数
    async function updateCommentCountFromGiscus(thoughtId) {
        console.log('Comments.html: Updating comment count from Giscus for thought:', thoughtId);
        
        try {
            // 构建Giscus API请求URL
            const pagePath = window.location.pathname;
            const uniqueId = `${pagePath}#${thoughtId}`;
            
            // 使用GitHub API获取讨论数量
            const repo = '{{ .Site.Params.comments.giscus.repo }}';
            const categoryId = '{{ .Site.Params.comments.giscus.categoryId }}';
            
            if (!repo || !categoryId) {
                console.warn('Comments.html: Giscus configuration not found');
                return;
            }
            
            // 构建GraphQL查询
            const query = `
                query {
                    repository(owner: "${repo.split('/')[0]}", name: "${repo.split('/')[1]}") {
                        discussions(categoryId: "${categoryId}", first: 100) {
                            nodes {
                                title
                                comments {
                                    totalCount
                                }
                            }
                        }
                    }
                }
            `;
            
            // 发送GraphQL请求
            const response = await fetch('https://api.github.com/graphql', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'bearer {{ .Site.Params.comments.giscus.token | default "" }}'
                },
                body: JSON.stringify({ query })
            });
            
            if (!response.ok) {
                throw new Error(`GitHub API request failed: ${response.status}`);
            }
            
            const data = await response.json();
            const discussions = data.data.repository.discussions.nodes;
            
            // 查找匹配的讨论
            const discussion = discussions.find(d => d.title === uniqueId || d.title.includes(thoughtId));
            
            if (discussion) {
                const count = discussion.comments.totalCount;
                // 更新页面上的评论计数
                const commentButtons = document.querySelectorAll(`.thought-action.comment-btn[data-thought-id="${thoughtId}"]`);
                commentButtons.forEach(button => {
                    const countSpan = button.querySelector('.comment-count');
                    if (countSpan) {
                        countSpan.textContent = count;
                        // 保存到本地存储
                        localStorage.setItem(`comment-count-${thoughtId}`, count);
                        console.log('Comments.html: Updated comment count for', thoughtId, 'to', count);
                    }
                });
            } else {
                console.log('Comments.html: No discussion found for thought:', thoughtId);
                // 如果没有找到讨论，设置评论数为0
                const commentButtons = document.querySelectorAll(`.thought-action.comment-btn[data-thought-id="${thoughtId}"]`);
                commentButtons.forEach(button => {
                    const countSpan = button.querySelector('.comment-count');
                    if (countSpan) {
                        countSpan.textContent = '0';
                        // 保存到本地存储
                        localStorage.setItem(`comment-count-${thoughtId}`, '0');
                    }
                });
            }
        } catch (error) {
            console.error('Comments.html: Error updating comment count from GitHub API:', error);
        }
    }
    
    // 创建全局 CommentManager 实例
    window.CommentManager = CommentManager;
    window.commentManager = new CommentManager();
    
    console.log('Giscus: Comment system initialized successfully');
    console.log('Comments.html: CommentManager instance created and attached to window object');
    
    // 添加一个全局标志，表示 CommentManager 已加载
    window.commentManagerLoaded = true;
</script>
{{- end }}