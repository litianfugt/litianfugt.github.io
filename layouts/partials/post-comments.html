{{- /* 博客文章评论系统 - 直接显示版本 */ -}}

{{- if .Site.Params.comments.enable }}
<div class="post-comments-container">
    <div class="post-comments-header">
        <h3 class="post-comments-title">评论</h3>
        <div class="post-comments-loading">加载评论中...</div>
    </div>
    <div class="giscus-wrapper" id="giscus-comments">
        <!-- Giscus评论将在这里加载 -->
    </div>
</div>

<style>
    .post-comments-container {
        margin-top: 3rem;
        padding-top: 2rem;
        border-top: 1px solid var(--border);
    }
    
    .post-comments-header {
        margin-bottom: 1.5rem;
    }
    
    .post-comments-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0 0 0.5rem 0;
        color: var(--primary);
    }
    
    .post-comments-loading {
        color: var(--secondary);
        font-size: 14px;
        text-align: center;
        padding: 20px;
    }
    
    .giscus-wrapper {
        border-radius: 8px;
        overflow: hidden;
    }
    
    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
        .giscus-wrapper {
            filter: brightness(0.9);
        }
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .post-comments-container {
            margin-top: 2rem;
            padding-top: 1.5rem;
        }
        
        .post-comments-title {
            font-size: 1.25rem;
        }
    }
</style>

<script>
    console.log('Post-comments: Starting to load Giscus for blog post...');
    
    // 重试计数器和配置
    let retryCount = 0;
    const maxRetries = 5; // 增加重试次数
    let isLoading = false;
    
    // 检测是否为GitHub Pages环境
    const isGitHubPages = window.location.hostname.includes('github.io') ||
                          window.location.hostname.includes('github.com');
    
    console.log('Post-comments: Environment detected:', isGitHubPages ? 'GitHub Pages' : 'Local/Other');
    
    // 验证Giscus配置
    function validateGiscusConfig() {
        const giscusRepo = '{{ .Site.Params.comments.giscus.repo }}';
        const giscusRepoId = '{{ .Site.Params.comments.giscus.repoId }}';
        const giscusCategory = '{{ .Site.Params.comments.giscus.category }}';
        const giscusCategoryId = '{{ .Site.Params.comments.giscus.categoryId }}';
        
        const config = {
            repo: giscusRepo || 'litianfugt/litianfugt.github.io',
            repoId: giscusRepoId || 'R_kgDOPkZVNQ',
            category: giscusCategory || 'General',
            categoryId: giscusCategoryId || 'DIC_kwDOPkZVNc4Cv3cN'
        };
        
        console.log('Post-comments: Giscus config validated:', config);
        return config;
    }
    
    // 博客文章评论加载函数 - 增强版
    function loadPostComments() {
        if (isLoading) {
            console.log('Post-comments: Already loading, skipping...');
            return;
        }
        
        isLoading = true;
        console.log('Post-comments: Loading Giscus for blog post, attempt:', retryCount + 1);
        
        const giscusWrapper = document.getElementById('giscus-comments');
        if (!giscusWrapper) {
            console.error('Post-comments: Giscus wrapper not found');
            isLoading = false;
            return;
        }
        
        // 清理现有的Giscus实例
        const existingFrame = giscusWrapper.querySelector('iframe.giscus-frame');
        const existingScript = giscusWrapper.querySelector('script[src*="giscus.app/client.js"]');
        
        if (existingFrame) {
            console.log('Post-comments: Removing existing frame');
            existingFrame.remove();
        }
        
        if (existingScript) {
            console.log('Post-comments: Removing existing script');
            existingScript.remove();
        }
        
        // 重置加载提示
        const loading = document.querySelector('.post-comments-loading');
        if (loading) {
            loading.style.display = 'block';
            loading.textContent = '加载评论中...';
            loading.style.color = '';
        }
        
        // 获取页面信息
        const pageTitle = document.title;
        const pagePath = window.location.pathname;
        const pageUrl = window.location.href;
        
        // 验证并获取Giscus配置
        const config = validateGiscusConfig();
        
        // 创建Giscus脚本
        const script = document.createElement('script');
        script.src = 'https://giscus.app/client.js';
        
        console.log('Post-comments: Using Giscus config:', config);
        
        // 设置Giscus配置
        script.setAttribute('data-repo', config.repo);
        script.setAttribute('data-repo-id', config.repoId);
        script.setAttribute('data-category', config.category);
        script.setAttribute('data-category-id', config.categoryId);
        script.setAttribute('data-mapping', 'pathname');
        script.setAttribute('data-term', pagePath);
        script.setAttribute('data-title', pageTitle);
        script.setAttribute('data-url', pageUrl);
        script.setAttribute('data-strict', '0');
        script.setAttribute('data-reactions-enabled', '1');
        script.setAttribute('data-emit-metadata', '0');
        script.setAttribute('data-input-position', 'bottom');
        script.setAttribute('data-theme', 'preferred_color_scheme');
        script.setAttribute('data-lang', 'zh-CN');
        
        // GitHub Pages环境下使用eager加载，本地环境可以使用lazy
        script.setAttribute('data-loading', isGitHubPages ? 'eager' : 'lazy');
        script.setAttribute('crossorigin', 'anonymous');
        script.setAttribute('async', '');
        
        // 设置超时处理
        const timeout = setTimeout(() => {
            console.error('Post-comments: Giscus load timeout');
            script.dispatchEvent(new Event('error'));
        }, isGitHubPages ? 15000 : 10000); // GitHub Pages环境下增加超时时间
        
        // 设置加载事件
        script.addEventListener('load', () => {
            clearTimeout(timeout);
            console.log('Post-comments: Giscus loaded successfully');
            const loading = document.querySelector('.post-comments-loading');
            if (loading) {
                loading.style.display = 'none';
            }
            // 重置重试计数器
            retryCount = 0;
            isLoading = false;
            
            // 更新评论计数
            setTimeout(() => {
                updatePostCommentCount();
            }, 1000); // 延迟1秒确保Giscus完全加载
        });
        
        // 设置错误事件
        script.addEventListener('error', () => {
            clearTimeout(timeout);
            console.error('Post-comments: Giscus load error');
            retryCount++;
            
            if (retryCount < maxRetries) {
                console.log('Post-comments: Retrying to load Giscus, attempt:', retryCount + 1);
                const loading = document.querySelector('.post-comments-loading');
                if (loading) {
                    loading.textContent = `评论加载失败，正在重试 (${retryCount}/${maxRetries})...`;
                    loading.style.color = '#FF9800';
                }
                
                // 延迟重试，GitHub Pages环境下使用更长的延迟
                const retryDelay = isGitHubPages ? 3000 : 2000;
                setTimeout(() => {
                    isLoading = false;
                    loadPostComments();
                }, retryDelay);
            } else {
                const loading = document.querySelector('.post-comments-loading');
                if (loading) {
                    loading.innerHTML = `
                        评论加载失败，请尝试以下解决方案：<br>
                        1. 刷新页面重试<br>
                        2. 检查网络连接<br>
                        3. 确认已登录GitHub账户<br>
                        <button onclick="loadPostComments()" style="margin-top: 10px; padding: 5px 10px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer;">手动重试</button>
                    `;
                    loading.style.color = '#F44336';
                }
                isLoading = false;
            }
        });
        
        // 添加脚本到页面
        giscusWrapper.appendChild(script);
        console.log('Post-comments: Giscus script added to page');
    }
    
    // 检查页面是否完全加载 - 增强版
    function waitForPageLoad(callback, maxAttempts = 20, interval = 500) {
        let attempts = 0;
        
        function check() {
            attempts++;
            console.log('Post-comments: Checking if page is fully loaded, attempt:', attempts);
            
            // 检查页面是否完全加载
            if (document.readyState === 'complete') {
                console.log('Post-comments: Page is fully loaded');
                callback();
            } else if (attempts < maxAttempts) {
                setTimeout(check, interval);
            } else {
                console.warn('Post-comments: Page did not fully load after maximum attempts, proceeding anyway');
                callback();
            }
        }
        
        check();
    }
    
    // 检查Giscus是否已成功加载
    function isGiscusLoaded() {
        const giscusFrame = document.querySelector('#giscus-comments iframe.giscus-frame');
        const giscusScript = document.querySelector('#giscus-comments script[src*="giscus.app/client.js"]');
        return !!(giscusFrame || giscusScript);
    }
    
    // 页面加载完成后自动加载评论 - 增强版
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Post-comments: DOM loaded, preparing to load comments...');
        
        // 等待页面完全加载后再加载评论
        waitForPageLoad(() => {
            console.log('Post-comments: Page is ready, loading comments...');
            
            // 检查是否已经加载
            if (!isGiscusLoaded()) {
                loadPostComments();
            } else {
                console.log('Post-comments: Giscus already loaded, skipping...');
            }
        });
    });
    
    // 使用 window.onload 作为备用加载机制
    window.addEventListener('load', function() {
        console.log('Post-comments: Window loaded, checking if comments need to be loaded...');
        
        // 检查评论是否已经加载
        if (!isGiscusLoaded()) {
            console.log('Post-comments: Comments not loaded yet, loading now...');
            loadPostComments();
        }
    });
    
    // 多级延迟加载作为备用方案 - 特别针对GitHub Pages
    setTimeout(() => {
        console.log('Post-comments: First delayed load check for GitHub Pages...');
        if (!isGiscusLoaded()) {
            console.log('Post-comments: Comments still not loaded after first delay, trying again...');
            // 重置重试计数器
            retryCount = 0;
            loadPostComments();
        }
    }, 3000); // 3秒后第一次检查
    
    setTimeout(() => {
        console.log('Post-comments: Second delayed load check for GitHub Pages...');
        if (!isGiscusLoaded()) {
            console.log('Post-comments: Comments still not loaded after second delay, trying with reset...');
            // 重置所有状态并重试
            retryCount = 0;
            isLoading = false;
            loadPostComments();
        }
    }, 6000); // 6秒后第二次检查
    
    setTimeout(() => {
        console.log('Post-comments: Final delayed load check for GitHub Pages...');
        if (!isGiscusLoaded()) {
            console.log('Post-comments: Comments still not loaded after final delay, showing error...');
            const loading = document.querySelector('.post-comments-loading');
            if (loading) {
                loading.innerHTML = `
                    评论系统加载失败，请尝试以下解决方案：<br>
                    1. 刷新页面重试<br>
                    2. 检查网络连接<br>
                    3. 确认已登录GitHub账户<br>
                    <button onclick="retryLoadComments()" style="margin-top: 10px; padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer;">手动重试</button>
                `;
                loading.style.color = '#F44336';
            }
        }
    }, 10000); // 10秒后最终检查
    
    // 提供手动重试函数
    window.retryLoadComments = function() {
        console.log('Post-comments: Manual retry triggered');
        retryCount = 0;
        isLoading = false;
        loadPostComments();
    };
    
    // 监听页面变化（例如：SPA导航）
    if (typeof window.addEventListener !== 'undefined') {
        window.addEventListener('popstate', function() {
            console.log('Post-comments: Page navigation detected, reloading comments...');
            // 重置重试计数器
            retryCount = 0;
            setTimeout(() => {
                loadPostComments();
            }, 100);
        });
    }
    
    // 监听主题变化，重新加载评论以适应新主题
    if (window.matchMedia) {
        const colorSchemeQuery = window.matchMedia('(prefers-color-scheme: dark)');
        colorSchemeQuery.addEventListener('change', (e) => {
            console.log('Post-comments: Color scheme changed, reloading comments...');
            // 重置重试计数器
            retryCount = 0;
            setTimeout(() => {
                loadPostComments();
            }, 100);
        });
    }
    
    console.log('Post-comments: Comment system initialized for blog post');
    
    // 更新文章评论计数
    async function updatePostCommentCount() {
        console.log('Post-comments: Updating comment count');
        
        try {
            // 获取页面信息
            const pagePath = window.location.pathname;
            const pageTitle = document.title;
            
            // 使用GitHub API获取讨论数量
            const repo = '{{ .Site.Params.comments.giscus.repo }}';
            const categoryId = '{{ .Site.Params.comments.giscus.categoryId }}';
            
            if (!repo || !categoryId) {
                console.warn('Post-comments: Giscus configuration not found');
                return;
            }
            
            // 构建GraphQL查询
            const query = `
                query {
                    repository(owner: "${repo.split('/')[0]}", name: "${repo.split('/')[1]}") {
                        discussions(categoryId: "${categoryId}", first: 100) {
                            nodes {
                                title
                                url
                                comments {
                                    totalCount
                                }
                            }
                        }
                    }
                }
            `;
            
            // 发送GraphQL请求
            const response = await fetch('https://api.github.com/graphql', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ query })
            });
            
            if (!response.ok) {
                console.warn('Post-comments: GraphQL request failed, trying REST API');
                // 如果GraphQL失败，尝试REST API作为备用
                await updateCommentCountFromREST(pagePath, pageTitle, repo, categoryId);
                return;
            }
            
            const data = await response.json();
            
            // 检查GraphQL响应中的错误
            if (data.errors) {
                console.warn('Post-comments: GraphQL errors detected, trying REST API:', data.errors);
                await updateCommentCountFromREST(pagePath, pageTitle, repo, categoryId);
                return;
            }
            
            const discussions = data.data.repository.discussions.nodes;
            
            // 查找匹配的讨论
            let discussion = null;
            
            // 首先尝试通过路径匹配
            discussion = discussions.find(d => d.url.includes(pagePath));
            
            // 如果没找到，尝试通过标题匹配
            if (!discussion) {
                discussion = discussions.find(d => d.title === pageTitle || d.title.includes(pagePath));
            }
            
            if (discussion) {
                const count = discussion.comments.totalCount;
                console.log('Post-comments: Found discussion with', count, 'comments');
                
                // 可以在这里更新页面上的评论计数显示
                // 例如，如果有评论计数徽章或其他UI元素
                const commentCountElements = document.querySelectorAll('.post-comment-count');
                commentCountElements.forEach(element => {
                    element.textContent = count;
                });
                
                // 保存到本地存储
                localStorage.setItem(`post-comment-count-${pagePath}`, count);
            } else {
                console.log('Post-comments: No discussion found for this page');
                // 设置评论数为0
                const commentCountElements = document.querySelectorAll('.post-comment-count');
                commentCountElements.forEach(element => {
                    element.textContent = '0';
                });
                localStorage.setItem(`post-comment-count-${pagePath}`, '0');
            }
        } catch (error) {
            console.error('Post-comments: Error updating comment count:', error);
            // 尝试使用REST API作为备用方案
            try {
                const pagePath = window.location.pathname;
                const pageTitle = document.title;
                const repo = '{{ .Site.Params.comments.giscus.repo }}';
                const categoryId = '{{ .Site.Params.comments.giscus.categoryId }}';
                await updateCommentCountFromREST(pagePath, pageTitle, repo, categoryId);
            } catch (restError) {
                console.error('Post-comments: REST API also failed:', restError);
            }
        }
    }
    
    // 使用REST API更新评论计数的备用方法
    async function updateCommentCountFromREST(pagePath, pageTitle, repo, categoryId) {
        console.log('Post-comments: Using REST API to update comment count');
        
        try {
            // 使用GitHub REST API获取讨论信息
            const apiUrl = `https://api.github.com/repos/${repo}/discussions?category_id=${categoryId}&per_page=100`;
            
            const response = await fetch(apiUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!response.ok) {
                throw new Error(`GitHub REST API request failed: ${response.status}`);
            }
            
            const discussions = await response.json();
            
            // 查找匹配的讨论
            let discussion = null;
            
            // 首先尝试通过路径匹配
            discussion = discussions.find(d => d.url && d.url.includes(pagePath));
            
            // 如果没找到，尝试通过标题匹配
            if (!discussion) {
                discussion = discussions.find(d => d.title === pageTitle || (d.title && d.title.includes(pagePath)));
            }
            
            if (discussion) {
                const count = discussion.comments || 0;
                console.log('Post-comments: Found discussion via REST API with', count, 'comments');
                
                // 更新页面上的评论计数
                const commentCountElements = document.querySelectorAll('.post-comment-count');
                commentCountElements.forEach(element => {
                    element.textContent = count;
                });
                
                // 保存到本地存储
                localStorage.setItem(`post-comment-count-${pagePath}`, count);
            } else {
                console.log('Post-comments: No discussion found for this page via REST API');
                // 设置评论数为0
                const commentCountElements = document.querySelectorAll('.post-comment-count');
                commentCountElements.forEach(element => {
                    element.textContent = '0';
                });
                localStorage.setItem(`post-comment-count-${pagePath}`, '0');
            }
        } catch (error) {
            console.error('Post-comments: REST API error:', error);
            // 最后的备用方案：从本地存储恢复或设置为0
            const storedCount = localStorage.getItem(`post-comment-count-${pagePath}`);
            const count = storedCount !== null ? storedCount : '0';
            
            const commentCountElements = document.querySelectorAll('.post-comment-count');
            commentCountElements.forEach(element => {
                element.textContent = count;
            });
        }
    }
    
    // 页面加载时尝试从本地存储恢复评论计数
    function restorePostCommentCount() {
        const pagePath = window.location.pathname;
        const storedCount = localStorage.getItem(`post-comment-count-${pagePath}`);
        
        if (storedCount !== null) {
            const commentCountElements = document.querySelectorAll('.post-comment-count');
            commentCountElements.forEach(element => {
                element.textContent = storedCount;
            });
            console.log('Post-comments: Restored comment count from localStorage:', storedCount);
        }
    }
    
    // 初始化时恢复评论计数
    restorePostCommentCount();
</script>
{{- end }}