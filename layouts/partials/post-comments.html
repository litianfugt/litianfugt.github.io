{{- /* 博客文章评论系统 - 简化版本，使用统一评论系统 */ -}}

{{- if .Site.Params.comments.enable }}
<div class="post-comments-container">
    <div class="post-comments-header">
        <h3 class="post-comments-title">评论</h3>
        <div class="post-comments-loading">加载评论中...</div>
    </div>
    <div class="giscus-wrapper" id="post-giscus-comments">
        <!-- Giscus评论将通过统一评论系统加载 -->
    </div>
</div>

<style>
    .post-comments-container {
        margin-top: 3rem;
        padding-top: 2rem;
        border-top: 1px solid var(--border);
    }
    
    .post-comments-header {
        margin-bottom: 1.5rem;
    }
    
    .post-comments-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0 0 0.5rem 0;
        color: var(--primary);
    }
    
    .post-comments-loading {
        color: var(--secondary);
        font-size: 14px;
        text-align: center;
        padding: 20px;
    }
    
    .giscus-wrapper {
        border-radius: 8px;
        overflow: hidden;
        min-height: 200px;
    }
    
    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
        .giscus-wrapper {
            filter: brightness(0.9);
        }
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .post-comments-container {
            margin-top: 2rem;
            padding-top: 1.5rem;
        }
        
        .post-comments-title {
            font-size: 1.25rem;
        }
    }
</style>

<script>
    console.log('Post-comments: Initializing simplified post comments...');
    
    // 等待统一评论系统加载完成
    function waitForUnifiedComments(callback, maxAttempts = 50, interval = 100) {
        let attempts = 0;
        
        function check() {
            attempts++;
            
            if (window.UnifiedComments && window.UnifiedComments.GiscusManager) {
                console.log('Post-comments: Unified comments system is ready');
                callback();
            } else if (attempts < maxAttempts) {
                setTimeout(check, interval);
            } else {
                console.warn('Post-comments: Unified comments system not found, falling back to manual loading');
                fallbackLoadComments();
            }
        }
        
        check();
    }
    
    // 后备加载方案
    function fallbackLoadComments() {
        console.log('Post-comments: Using fallback loading method');
        
        const container = document.getElementById('post-giscus-comments');
        const loading = document.querySelector('.post-comments-loading');
        
        if (!container) {
            console.error('Post-comments: Container not found');
            return;
        }
        
        // 设置Giscus配置
        const config = {
            repo: '{{ .Site.Params.comments.giscus.repo }}',
            repoId: '{{ .Site.Params.comments.giscus.repoId }}',
            category: '{{ .Site.Params.comments.giscus.category }}',
            categoryId: '{{ .Site.Params.comments.giscus.categoryId }}',
            mapping: 'pathname',
            strict: '0',
            reactionsEnabled: '1',
            emitMetadata: '1',
            inputPosition: 'bottom',
            theme: 'preferred_color_scheme',
            lang: 'zh-CN',
            loading: 'eager'
        };
        
        // 创建Giscus脚本
        const script = document.createElement('script');
        script.src = 'https://giscus.app/client.js';
        
        Object.entries(config).forEach(([key, value]) => {
            script.setAttribute(`data-${key}`, value);
        });
        
        script.setAttribute('data-term', window.location.pathname);
        script.setAttribute('data-title', document.title);
        script.setAttribute('crossorigin', 'anonymous');
        script.setAttribute('async', '');
        
        script.addEventListener('load', () => {
            console.log('Post-comments: Fallback Giscus loaded successfully');
            if (loading) {
                loading.style.display = 'none';
            }
        });
        
        script.addEventListener('error', () => {
            console.error('Post-comments: Fallback Giscus load failed');
            if (loading) {
                loading.textContent = '评论加载失败，请刷新页面重试';
                loading.style.color = '#F44336';
            }
        });
        
        container.appendChild(script);
    }
    
    // 使用统一评论系统加载评论
    function loadPostCommentsWithUnifiedSystem() {
        console.log('Post-comments: Loading comments with unified system');
        
        const container = document.getElementById('post-giscus-comments');
        const loading = document.querySelector('.post-comments-loading');
        
        if (!container) {
            console.error('Post-comments: Container not found');
            return;
        }
        
        // 使用统一评论系统的Giscus管理器
        try {
            const result = window.UnifiedComments.GiscusManager.createInstance(container, 'post-' + window.location.pathname);
            
            if (result) {
                console.log('Post-comments: Comments loading initiated');
                
                // 监听加载完成
                setTimeout(() => {
                    if (loading) {
                        loading.style.display = 'none';
                    }
                }, 2000);
            } else {
                console.warn('Post-comments: Failed to create Giscus instance, using fallback');
                fallbackLoadComments();
            }
        } catch (error) {
            console.error('Post-comments: Error using unified system:', error);
            fallbackLoadComments();
        }
    }
    
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Post-comments: DOM loaded, waiting for unified comments system...');
        
        waitForUnifiedComments(() => {
            loadPostCommentsWithUnifiedSystem();
        });
    });
    
    // 监听主题变化
    window.addEventListener('themeChanged', function(event) {
        console.log('Post-comments: Theme changed, updating comments');
        
        // 更新Giscus主题
        const giscusFrames = document.querySelectorAll('#post-giscus-comments iframe.giscus-frame');
        giscusFrames.forEach(frame => {
            try {
                frame.contentWindow.postMessage({
                    giscus: {
                        setConfig: {
                            theme: event.detail.theme
                        }
                    }
                }, 'https://giscus.app');
            } catch (error) {
                console.warn('Post-comments: Failed to update Giscus theme:', error);
            }
        });
    });
    
    console.log('Post-comments: Simplified comment system initialized');
</script>
{{- end }}
